{% load static %}
<!DOCTYPE html>
<html>      
  <head>
    <link rel="stylesheet" href="{% static 'css/survey.css' %}" />
    <meta charset="utf-8" />
    <title>추천 결과</title>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script
      type="text/javascript"
      src="//dapi.kakao.com/v2/maps/sdk.js?appkey=5d4ec92d180013aec536b3174ee43503&libraries=services,clusterer,drawing"
    ></script>

    <style>
      .header {
        text-align: center;
        margin: 20px 0;
        font-size: 24px;
        font-weight: bold;
      }

      body {
        display: flex;
      }

      .left,
      .center {
        flex: 0.5;
        padding: 10px;
        border: 1px solid gray;
      }

      .right {
        flex: 2;
        padding: 10px;
        border: 1px solid gray;
      }

      /* 기존의 CSS 스타일 */
      .dot {
        ...;
      }
      .dotOverlay {
        ...;
      }
      .number {
        ...;
      }
      .dotOverlay:after {
        ...;
      }
      .distanceInfo {
        ...;
      }
      .distanceInfo .label {
        ...;
      }
      .distanceInfo:after {
        ...;
      }

      #map {
        width: 100%;
        height: 700px;
      }
      .label {
        padding: 1rem;
        background: white;
        border: 1px solid blue;
      }
      .button {
        margin: 3px;
        background-color: #e9e9e9;
        padding: 1px 1px
      }
      .day-buttons{
        text-align: right;
      }
    </style>
  </head>
  <body>
  <div class="topnav">
        <a class="active" href="{% url 'triprecommender:survey'%}">Home</a>
        <a href="#" onclick="reloadPage();">Result</a>
        <a href="#about" class="split">Help</a>
   </div>
    <div class="left">
      <div class="header">당신을 위한 추천 방문지</div>
      {% for place in places %}
      <div>
        <span class='button' onclick="window.open('https://map.kakao.com/link/map/{{place.visit_area_name}},{{place.ycoord}},{{place.xcoord}}')" data-ycoord="{{ place.ycoord }}" data-xcoord="{{ place.xcoord }}">{{ place.visit_area_name }} </span>
        <div class="day-buttons" style="display: none">
          {% for i in "1234"|make_list %}
          <button
            onclick="addToItinerary('{{ i }}', '{{ place.visit_area_name }}', {{ place.ycoord }}, {{ place.xcoord }}')"
          >
            Day {{ i }}
          </button>
          {% endfor %}
        </div>
      </div>
      {% endfor %}
    </div>

    <div class="center">
      <h2 class="header">여행 일정 선택</h2>
      <select id="travel-duration">
        <option value="">일정 선택</option>
        <option value="1">1박 2일</option>
        <option value="2">2박 3일</option>
        <option value="3">3박 4일</option>
      </select>

      <div id="itinerary"></div>
    </div>

<script>
    function reloadPage() {
        location.reload(true);
    }

    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.addEventListener('DOMContentLoaded', function () {
        var mapContainer = document.getElementById('map'),
            mapOptions = {
                center: new kakao.maps.LatLng(33.3972, 126.5448),
                level: 9
            };

        var map = new kakao.maps.Map(mapContainer, mapOptions);
        positions
        var positions = [
        {% for place in places %}
            {
                content: '<div>{{place.visit_area_name}}<br><a href="https://map.kakao.com/link/map/{{place.visit_area_name}},{{place.ycoord}},{{place.xcoord}}" style="color:blue" target="_blank">큰지도보기</a> <a href="https://map.kakao.com/link/to/{{place.visit_area_name}},{{place.ycoord}},{{place.xcoord}}" style="color:blue" target="_blank">길찾기</a></div>', 
                latlng: new kakao.maps.LatLng({{place.ycoord}}, {{place.xcoord}})
            },

        {% endfor %}
                                               
    <div class="right">
        <div id="map"></div>
      </div>

    <script>

          function getCookie(name) {
              var cookieValue = null;
              if (document.cookie && document.cookie !== '') {
                  var cookies = document.cookie.split(';');
                  for (var i = 0; i < cookies.length; i++) {
                      var cookie = cookies[i].trim();
                      if (cookie.substring(0, name.length + 1) === (name + '=')) {
                          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                          break;
                      }
                  }
              }
              return cookieValue;
          }

          document.addEventListener('DOMContentLoaded', function () {
              var mapContainer = document.getElementById('map'),
                  mapOptions = {
                      center: new kakao.maps.LatLng(33.3972, 126.5678),
                      level: 9
                  };

              var map = new kakao.maps.Map(mapContainer, mapOptions);
              positions
              var positions = [
              {% for place in places %}
                  {
                      content: '<div>{{place.visit_area_name}}</div>',
                      latlng: new kakao.maps.LatLng({{place.ycoord}}, {{place.xcoord}})
                  },

              {% endfor %}

              ];

              for (var i = 0; i < positions.length; i ++) {
                  // 마커를 생성합니다
                  var marker = new kakao.maps.Marker({
                      map: map, // 마커를 표시할 지도
                      position: positions[i].latlng // 마커의 위치
                  });

                  // 마커에 표시할 인포윈도우를 생성합니다
                  var infowindow = new kakao.maps.InfoWindow({
                      content: positions[i].content // 인포윈도우에 표시할 내용
                  });

                  infowindow.open(map,marker)

                  // 마커에 mouseover 이벤트와 mouseout 이벤트를 등록합니다
                  // 이벤트 리스너로는 클로저를 만들어 등록합니다
                  // for문에서 클로저를 만들어 주지 않으면 마지막 마커에만 이벤트가 등록됩니다
              }

              // 인포윈도우를 표시하는 클로저를 만드는 함수입니다
              function makeOverListener(map, marker, infowindow) {
                  return function() {
                      infowindow.open(map, marker);
                  };
              }

              // 인포윈도우를 닫는 클로저를 만드는 함수입니다
              function makeOutListener(infowindow) {
                  return function() {
                      infowindow.close();
                  };
              }

              window.drawPolyline = function (day, originY, originX, destinationY, destinationX) {
                  var data = {
                      origin: { x: originX.toString(), y: originY.toString() },
                      destination: { x: destinationX.toString(), y: destinationY.toString() },
                      priority: "RECOMMEND",
                      car_fuel: "GASOLINE",
                      car_hipass: false,
                      alternatives: false,
                      road_details: false
                  };

                  fetch('{% url "triprecommender:proxy_to_kakao" %}', {
                      method: 'POST',
                      headers: {
                          'Content-Type': 'application/json',
                          'X-CSRFToken': getCookie('csrftoken')
                      },
                      body: JSON.stringify(data)
                  })
                  .then(response => response.json())
                  .then(data => {
                      console.log('data:',data);
                      // 응답 데이터의 summary에서 출발지와 목적지 좌표 추출
                      var origin = data.routes[0].summary.origin;
                      var destination = data.routes[0].summary.destination;

                      // 출발지 마커 생성
                      var originLatLng = new kakao.maps.LatLng(origin.y, origin.x);
                      var originMarker = new kakao.maps.Marker({
                          map: map,
                          position: originLatLng
                      });

                      // 목적지 마커 생성
                      var destinationLatLng = new kakao.maps.LatLng(destination.y, destination.x);
                      var destinationMarker = new kakao.maps.Marker({
                          map: map,
                          position: destinationLatLng
                      });

                      let sections = data.routes[0].sections[0];
                      let linePath = sections.roads.map(road => {
                          return road.vertexes.map((vertex, index) => {
                              if (index % 2 === 0) {
                                  return new kakao.maps.LatLng(road.vertexes[index + 1], road.vertexes[index]);
                              }
                          }).filter(vertex => vertex !== undefined);
                      }).flat();

                      let color;
                        if (day === '1') color = '#FF0000';      // Day 1: 빨간색
                        else if (day === '2') color = '#00FF00'; // Day 2: 녹색
                        else if (day === '3') color = '#0000FF'; // Day 3: 파란색
                        else color = '#FFA500';                  // Day 4: 오렌지색

                      let polyline = new kakao.maps.Polyline({
                          path: linePath,
                          strokeWeight: 5,
                          strokeColor: color,
                          strokeOpacity: 0.7,
                          strokeStyle: 'solid'
                      });

                      polyline.setMap(map);
                  })
                  .catch(err => console.error("API 요청 오류:", err));
              }
          });

          $(document).ready(function() {
            // 전역 변수로 선택된 장소를 저장
            var selectedPlaces = { day1: [], day2: [], day3: [], day4: [] };
        
            $('#travel-duration').change(function() {
                var nights = $(this).val();
                var days = parseInt(nights) + 1;
        
                // 모든 장소의 Day 버튼을 업데이트합니다.
                updateDayButtons(days);
        
                // 일정 HTML을 업데이트합니다.
                updateItineraryHtml(days);
            });
        
            function updateDayButtons(days) {
                $('.day-buttons').each(function() {
                    var buttonsHtml = '';
                    var placeName = $(this).prev('span').text();
                    var yCoord = $(this).prev('span').data('ycoord');
                    var xCoord = $(this).prev('span').data('xcoord');
        
                    for (var i = 1; i <= days; i++) {
                        buttonsHtml += '<button onclick="addToItinerary(\'' + i + '\', \'' + placeName + '\', ' + yCoord + ', ' + xCoord + ')">Day ' + i + '</button>';
                    }
                    $(this).html(buttonsHtml).show();
                });
            }
        
            function updateItineraryHtml(days) {
                var itineraryHtml = '';
                for (var i = 1; i <= days; i++) {
                    itineraryHtml += '<div id="day' + i + '" style="background-color: ' + getColorForDay(i) + ';">';
                    itineraryHtml += '<h3>Day ' + i + '</h3>';
                    itineraryHtml += '</div>';
                }
                $('#itinerary').html(itineraryHtml);
        
                // 이미 선택된 방문지를 다시 표시합니다.
                Object.keys(selectedPlaces).forEach(function(dayKey) {
                    updateItinerary(dayKey);
                });
            }
        
            window.addToItinerary = function(day, name, y, x) {
                var dayKey = 'day' + day;
                selectedPlaces[dayKey].push({ name: name, y: y, x: x });
                updateItinerary(dayKey);

                if (selectedPlaces[dayKey].length >= 2) {
                    var origin = selectedPlaces[dayKey][0];
                    var destination = selectedPlaces[dayKey][selectedPlaces[dayKey].length - 1];
                    drawPolyline(day, origin.y, origin.x, destination.y, destination.x);
                }
            };
        
            function updateItinerary(dayKey) {
                var itineraryHtml = '<h3>' + dayKey + '</h3>';
                selectedPlaces[dayKey].forEach(function(place, index) {
                    itineraryHtml += '<div>' + (index + 1) + '. ' + place.name + ' <a href="https://map.kakao.com/link/to/' + encodeURIComponent(place.name) + ',' + place.y + ',' + place.x + '" style="color:blue" target="_blank">길찾기</a></div>';
                });
                $('#itinerary #' + dayKey).html(itineraryHtml);
            }
        
            function getColorForDay(day) {
                var colors = ['#FFDDDD', '#DDFFDD', '#DDDDFF', '#FFD700'];
                return colors[(day - 1) % colors.length];
            }
        });
    </script>
  </body>
</html>
