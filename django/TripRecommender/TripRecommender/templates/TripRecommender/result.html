{% load static %} {% load custom_filters %}
<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="{% static 'css/survey.css' %}" />
    <meta charset="utf-8" />
    <title>추천 결과</title>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script
      type="text/javascript"
      src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{api_key}}&libraries=services,clusterer,drawing"
    ></script>

    <style>
      .header {
        text-align: center;
        margin: 20px 0;
        font-size: 24px;
        font-weight: bold;
      }

      body {
        display: flex;
      }

      .left {
        flex: 0.5;
        padding: 10px;
        border: 1px solid gray;
        height: 700px; /* 고정 높이 설정 */
        overflow-y: auto; /* 세로 스크롤 활성화 */
      }
      .center {
        flex: 0.5;
        padding: 10px;
        border: 1px solid gray;
      }

      .right {
        flex: 2;
        padding: 10px;
        border: 1px solid gray;
      }

      /* 기존의 CSS 스타일 */
      .dot {
        ...;
      }
      .dotOverlay {
        ...;
      }
      .number {
        ...;
      }
      .dotOverlay:after {
        ...;
      }
      .distanceInfo {
        ...;
      }
      .distanceInfo .label {
        ...;
      }
      .distanceInfo:after {
        ...;
      }

      #map {
        width: 100%;
        height: 700px;
      }
      .label {
        padding: 1rem;
        background: white;
        border: 1px solid blue;
      }
      .button {
        margin: 3px;
        text-align: left;
        background-color: #bbf5bb;
        padding: 1px 1px;
      }
      .day-buttons {
        text-align: right;
      }

      .button {
        display: flex; /* Flexbox 레이아웃 사용 */
        align-items: center; /* 세로 방향 중앙 정렬 */
      }
    
      .button img {
        margin-bottom: 5px; /* 이미지와 텍스트 사이에 여백 추가 */
      }

    </style>
  </head>
  <body>
    <div class="left">
      <div class="header">당신을 위한 추천 방문지</div>
      {% for place in places %}
      <div>
        <span
          class="button"
          onclick="window.open('https://map.kakao.com/link/map/{{place.visit_area_name}},{{place.ycoord}},{{place.xcoord}}')"
          data-ycoord="{{ place.ycoord }}"
          data-xcoord="{{ place.xcoord }}"
        >
          <img
            src="{% static forloop.counter|add_png %}"
            style="width: 30px; height: 25px"
          />
          <img
            <img
            src="{{ place.main_image.url }}"
            style="width: 60px; height: 60px"
          /> <h4> {{ place.visit_area_name }}</h4>
        </span>
        <div class="day-buttons" style="display: none">
          {% for i in "1234"|make_list %}
          <button
            onclick="addToItinerary('{{ i }}', '{{ place.visit_area_name }}', {{ place.ycoord }}, {{ place.xcoord }}')"
          >
            Day {{ i }}
          </button>
          {% endfor %}
        </div>
      </div>
      {% endfor %}
    </div>

    <div class="center">
      <h2 class="header">여행 일정 선택</h2>
      <select id="travel-duration">
        <option value="">일정 선택</option>
        <option value="1">1박 2일</option>
        <option value="2">2박 3일</option>
        <option value="3">3박 4일</option>
      </select>

      <div id="itinerary"></div>
    </div>

    <div class="right">
      <div id="map"></div>
    </div>

    <script>
        var polylines = {};
        var selectedPlaces = { day1: [], day2: [], day3: [], day4: [] };
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }



        document.addEventListener('DOMContentLoaded', function () {
            var mapContainer = document.getElementById('map'),
                mapOptions = {
                    center: new kakao.maps.LatLng(33.3972, 126.5678),
                    level: 9
                };

            var map = new kakao.maps.Map(mapContainer, mapOptions);

            console.log(map);
            positions
            var positions = [
            {% for place in places %}
                {
                    content: '<div><img src="{{ place.main_image.url }}" style="width: 200px;"></div>',
                    title: '{{place.visit_area_name}}',
                    latlng: new kakao.maps.LatLng({{place.ycoord}}, {{place.xcoord}})
                },

            {% endfor %}

            ];



            window.drawPolyline = function(day) {
              var dayKey = 'day' + day;
              var places = selectedPlaces[dayKey];

              if (polylines[dayKey]){
                polylines[dayKey].setMap(null)
              }

              // 선택된 장소 로그 출력
              console.log("선택된 장소:", places);

              if (places.length < 2) {
                  console.log("경로를 그리기 위해서는 최소 2개 이상의 방문지가 필요합니다.");
                  return;
              }

              var origin = places[0];
              var destination = places[places.length - 1];
              var waypoints = places.slice(1, -1).map(place => ({ x: place.x.toString(), y: place.y.toString() }));

              // 원점, 목적지, 경유지 로그 출력
              console.log("원점:", origin);
              console.log("목적지:", destination);
              console.log("경유지:", waypoints);

              var data = {
                  origin: { x: origin.x.toString(), y: origin.y.toString() },
                  destination: { x: destination.x.toString(), y: destination.y.toString() },
                  waypoints: waypoints,
                  priority: "RECOMMEND",
                  car_fuel: "GASOLINE",
                  car_hipass: false,
                  alternatives: false,
                  road_details: false
              };

              fetch('{% url "triprecommender:proxy_to_kakao" %}', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                      'X-CSRFToken': getCookie('csrftoken')
                  },
                  body: JSON.stringify(data)
              })
              .then(response => response.json())
              .then(data => {
                  console.log('API 응답:', data);

                  var origin = data.routes[0].summary.origin;
                  var destination = data.routes[0].summary.destination;

                  let sections = data.routes[0].sections[0];
                  // 각 섹션에 대해 linePath 생성
                  let linePath = [];
                  data.routes[0].sections.forEach(section => {
                      section.roads.forEach(road => {
                          let roadPath = road.vertexes.map((vertex, index) => {
                              if (index % 2 === 0) {
                                  return new kakao.maps.LatLng(road.vertexes[index + 1], road.vertexes[index]);
                              }
                          }).filter(vertex => vertex !== undefined);
                          linePath = linePath.concat(roadPath);
                      });
                  });

                  // linePath 로그 출력
                  console.log("linePath:", linePath);

                  let color;
                  if (day === '1') color = '#FF0000';      // Day 1: 빨간색
                  else if (day === '2') color = '#00FF00'; // Day 2: 녹색
                  else if (day === '3') color = '#0000FF'; // Day 3: 파란색
                  else color = '#FFA500';                  // Day 4: 오렌지색

                  console.log("Polyline 생성 전")
                  let polyline = new kakao.maps.Polyline({
                      path: linePath,
                      strokeWeight: 5,
                      strokeColor: color,
                      strokeOpacity: 0.7,
                      strokeStyle: 'solid'
                  });
                  console.log("Polyline 지도에 추가 전")
                  polyline.setMap(map);
                  polylines[dayKey] = polyline;
                  console.log("새로운 폴리라인 저장:", polyline);
              })
              .catch(err => console.error("API 요청 오류:", err));
          };



            for (var i = 0; i < positions.length; i ++) {
                var imageSrc = "{% static '' %}" + (i+1) + ".png";
                // 마커 이미지의 이미지 크기 입니다
                var imageSize = new kakao.maps.Size(35, 40);

                // 마커 이미지를 생성합니다
                var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize);

                // 마커를 생성합니다
                var marker = new kakao.maps.Marker({
                    map: map, // 마커를 표시할 지도
                    position: positions[i].latlng, // 마커를 표시할 위치
                    title : positions[i].title, // 마커의 타이틀, 마커에 마우스를 올리면 타이틀이 표시됩니다
                    image : markerImage // 마커 이미지
                });
                var infowindow = new kakao.maps.InfoWindow({
                  content: positions[i].content // 인포윈도우에 표시할 내용
              });

              // 마커에 mouseover 이벤트와 mouseout 이벤트를 등록합니다
              // 이벤트 리스너로는 클로저를 만들어 등록합니다
              // for문에서 클로저를 만들어 주지 않으면 마지막 마커에만 이벤트가 등록됩니다
              kakao.maps.event.addListener(marker, 'mouseover', makeOverListener(map, marker, infowindow));
              kakao.maps.event.addListener(marker, 'mouseout', makeOutListener(infowindow));




            }

          // 인포윈도우를 표시하는 클로저를 만드는 함수입니다
          function makeOverListener(map, marker, infowindow) {
            return function() {
                infowindow.open(map, marker);
            };
          }

          // 인포윈도우를 닫는 클로저를 만드는 함수입니다
          function makeOutListener(infowindow) {
            return function() {
                infowindow.close();
            };
          }

        });

        $(document).ready(function() {



          function updateDayButtons(days) {
              $('.day-buttons').each(function() {
                  var buttonsHtml = '';
                  var placeName = $(this).prev('span').text().trim();
                  var yCoord = $(this).prev('span').data('ycoord');
                  var xCoord = $(this).prev('span').data('xcoord');

                  for (var i = 1; i <= days; i++) {
                      buttonsHtml += '<button onclick="addToItinerary(\'' + i + '\', \'' + placeName + '\', ' + yCoord + ', ' + xCoord + ')">Day ' + i + '</button>';
                  }
                  $(this).html(buttonsHtml).show();
              });
          }



          window.addToItinerary = function(day, name, y, x) {
            console.log(day,name,y,x)
            var dayKey = 'day' + day;
              selectedPlaces[dayKey].push({ name: name, y: y, x: x });
              updateDayItinerary(dayKey);

              if (selectedPlaces[dayKey].length >= 2) {
                  var origin = selectedPlaces[dayKey][0];
                  var destination = selectedPlaces[dayKey][selectedPlaces[dayKey].length - 1];
                  console.log("selectedPlace[daykey].length >= 2")
                  drawPolyline(day, origin.y, origin.x, destination.y, destination.x);
              }
          };

          function updateDayItinerary(dayKey) {

            console.log("updateDayItinerary 함수 호출됨:", dayKey)
            var itineraryContent = '';
            selectedPlaces[dayKey].forEach(function(place, index) {
                itineraryContent += '<div>' + (index + 1) + '. ' + place.name + ' <a href="https://map.kakao.com/link/to/' + encodeURIComponent(place.name) + ',' + place.y + ',' + place.x + '" style="color:blue" target="_blank">길찾기</a></div>';
            });
            // 기존의 제목과 초기화 버튼을 유지하고, 새로운 일정 내용만 추가합니다.
            var $dayContainer = $('#itinerary #' + dayKey);
            $dayContainer.find('h3').nextAll().remove(); // 기존 일정 내용을 제거
            $dayContainer.append(itineraryContent); // 새로운 일정 내용 추가
            $dayContainer.append('<button class="reset-day" data-day="' + dayKey.replace('day', '') + '">Day ' + dayKey.replace('day', '') + ' 초기화</button>'); // 초기화 버튼 추가
        }

          // 초기화 버튼 클릭 이벤트 핸들러
          $(document).on('click', '.reset-day', function() {
            var day = $(this).data('day');
            var dayKey = 'day' + day;

            // 해당 일의 방문지와 폴리라인 초기화
            selectedPlaces[dayKey] = [];
            if (polylines[dayKey]) {
              polylines[dayKey].setMap(null);
              delete polylines[dayKey];
            }

            // 해당 일정 박스의 내용 초기화
            $('#day' + day).empty().append('<h3>Day ' + day + '</h3>');
            $('<button class="reset-day" data-day="' + day + '">Day ' + day + ' 초기화</button>').appendTo('#day' + day);
          });

          function getColorForDay(day) {
              var colors = ['#FFDDDD', '#DDFFDD', '#DDDDFF', '#FFD700'];
              return colors[(day - 1) % colors.length];
          }
          console.log("Itinerary element:", $('#itinerary').length > 0 ? "Found" : "Not Found");

          $('#travel-duration').change(function() {
            var nights = $(this).val();
            var days = parseInt(nights) + 1;

            // 모든 장소의 Day 버튼을 업데이트합니다.
            updateDayButtons(days);

            // 일정 HTML을 업데이트합니다.
            initializeItineraryHtml(days);
        });

        function initializeItineraryHtml(days) {
          console.log("selectedPlaces 객체:",selectedPlaces)
          var itineraryHtml = '';
          for (var i = 1; i <= days; i++) {
              itineraryHtml += '<div id="day' + i + '" style="background-color: ' + getColorForDay(i) + ';">';
              itineraryHtml += '<h3>Day ' + i + '</h3>'; // 제목 설정
              itineraryHtml += '<button class="reset-day" data-day="' + i + '">Day ' + i + ' 초기화</button>'; // 초기화 버튼 추가
              itineraryHtml += '</div>';
          }
          $('#itinerary').html(itineraryHtml); // 전체 일정 내용을 초기화합니다.

          Object.keys(selectedPlaces).forEach(function(dayKey) {
              updateDayItinerary(dayKey); // 각 일자의 방문지 목록을 업데이트합니다.
          });
          console.log('InitializeItineraryHtml:',itineraryHtml)
      }

      });
    </script>
  </body>
</html>
